<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Athens GIS Repository</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { width: 100%; height: 100%; }
    
    /* Modal overlay */
    #welcomeModal {
      position: fixed;
      z-index: 2000; /* above everything else */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6); /* dark overlay */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Modal content box */
    #welcomeContent {
      background-color: rgba(252, 251, 246, 0.9);
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      text-align: center;
      font-family: Helvetica;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    
    #welcomeContent h2 {
      margin-top: 0;
    }
    
    #welcomeContent button {
      margin-top: 20px;
      padding: 8px 20px;
      background-color: white;
      border: 1px solid #4682B4;
      color: black;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      transition-duration: 0.4s;
    }
    
    #welcomeContent button:hover {
      background-color: #4682B4;
      color: white;
    }

    header {
      position: absolute;
      top: 0;
      width: 100%;
      background: rgba(70,130,180, 0.8);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
      color: black;
      text-align: center;
      font-weight: 400;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      padding: 10px;
      font-size: 1.2em;
      font-family: Helvetica;
      z-index: 1000;
    }

    #layerControl {
      position: absolute;
      top: 60px;      /* below header */
      bottom: 250px;   /* above footer */
      left: 10px;     /* left side */
      width: 250px;   /* adjust width as needed */
      background: rgba(252, 251, 246, 0.9); /* white with 90% opacity */
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      overflow-y: auto;     /* makes it scrollable */
      z-index: 999;
      font-size: 12px;
      font-family: Helvetica;
    }

    #layerControl h4 {
      margin: 8px 0 4px;
      font-size: 14px;
    }

    #layerInfoBox {
      position: fixed;
      bottom: 50px;   /* above footer */
      left: 10px;
      width: 250px;
      height: 160px;
      overflow-y: auto;
      background: rgba(252, 251, 246, 0.9);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 12px;
      font-family: Helvetica;
      display: none;  /* hidden by default */
      z-index: 2000;  /* ✅ force on top! */
    }

    #footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,255,240, 0.9);
      color: grey;
      text-align: center;
      padding: 5px;
      font-size: 11px;
      font-family: Helvetica;
      z-index: 1000;
    }

    .layer-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .layer-item label {
      flex-grow: 1;
      margin-left: 4px;
    }

    /* Make checkboxes look circular */
    .layer-item input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border: 1px solid #4682B4;
      border-radius: 50%; /* Makes it a circle */
      background-color: white;
      cursor: pointer;
      outline: none;
      position: relative;
    }
    
    .layer-item input[type="checkbox"]:checked {
      background-color: #4682B4;
    }
    
    .layer-item input[type="checkbox"]::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: white;
      display: none;
    }
    
    .layer-item input[type="checkbox"]:checked::after {
      display: block;
    }

    .layer-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1px 0;
    }

    .download-button {
      display: inline-block;
      background: white;
      color: black;
      border: 1px solid #4682B4;
      padding: 2px 4px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
      cursor: pointer;
      line-height: 1;
      flex-shrink: 0;
      transition-duration: 0.4s;
    }
    .download-button:hover {
      background: #4682B4;
      color: white;
    }
    
    .leaflet-control-layers {
      top: 40px !important;   /* adjust basemap top offset here */
      right: 0px !important; /* keep right */
    }
    .leaflet-popup-content table {
      border-collapse: collapse;
      width: 100%;
    }
    
    .leaflet-popup-content th,
    .leaflet-popup-content td {
      border-bottom: 1px solid #ddd;
      padding: 4px;
      font-size: 12px;
    }
    
    .leaflet-popup-content th {
      background: #f0f0f0;
      font-weight: bold;
    }
  </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BSNF6CGQ5J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BSNF6CGQ5J');
</script>  

<body>

<header>Athens GIS Repository</header>

<div id="map"></div>

<div id="layerInfoBox"></div>

<div id="layerControl">
  <!-- Categories and checkboxes will be generated here -->
</div>

<div id="footer">
  Created by Konstantinos Markos | PhD Candidate, SRSGE, NTUA
</div>

<!-- Welcome Modal -->
<div id="welcomeModal">
  <div id="welcomeContent">
    <h2>Welcome to Athens GIS Repository</h2>
    <p>
     <strong>ALPHA VERSION</strong>
    </p>    
    <p>
      Here you can find information about the administrative boundaries, transportation systems, and environment of the Athens Metropolitan Area.
    </p>
    <p>
      On the left side of the map, select as many layers as you wish to explore, and then click the blue button to download them.
    </p>
    <p>
      At the top right of the map, you can browse interesting basemaps to help you explore the data.
    </p>
    <p><strong>Have fun!</strong></p>
    <button id="closeWelcome">OK</button>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  var activeLayerInfos = {}; // store info for all active layers

  // === Initialize map ===
  var map = L.map('map', {
    zoomControl: false  // turn off default zoom control
  }).setView([37.98, 23.72], 12);
  
    // Add zoom in top-right
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  var positron = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  });

  var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri'
  });

  var darkMatter = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
    subdomains: 'abcd',
    maxZoom: 19
  });

  var baseMaps = {
    "Carto Light BaseMap": positron,
    "Carto Dark BaseMap": darkMatter,
    "OpenStreetMap": osm,
    "Esri Satellite": esriSat
  };

        // Add basemap switcher in top-right (or elsewhere)
  L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

  // === Define layers by category ===
  var layerCategories = {
    "Administrative Boundaries": [
      { name: "Athens Center Sector", file: "AthensCenterSector.geojson" },
      { name: "Athens South Sector", file: "AthensSouthSector.json" },
      { name: "Athens North Sector", file: "AthensNorthSector.json" },
      { name: "Athens West Sector", file: "AthensWestSector.json" },
      { name: "Athens Western Area", file: "AthensWest.json" },
      { name: "Athens Eastern Area", file: "AthensEast.geojson" },
      { name: "Piraeus", file: "Piraeus.json" }
    ],
    "Transportation": [
      { name: "Metro Stations 1, 2 & 3 ", file: "AthensMetro123.geojson" },
      { name: "Train/OSE Stations", file: "AthensTrain.geojson" },
      { name: "Tram Stations", file: "AthensTram.geojson" },
      { name: "Bus Stops", file: "AthensBusStops.geojson" },
      { name: "Highways", file: "AthensHighways.json" },
      { name: "Avenues", file: "AthensAvenues.json" }
    ],
    "Environment": [
      { name: "Athens Center Green Spaces", file: "AthensGreenCenter.geojson" },
      { name: "Athens South Green Spaces", file: "AthensGreenSouth.geojson" },
      { name: "Athens West Green Spaces", file: "AthensGreenWest.geojson" },
      { name: "Piraeus Green Spaces", file: "PiraeusGreen.geojson" }
    ]
  };

  // === Active layers ===
  var geojsonLayers = {};

  var controlDiv = document.getElementById('layerControl');
  
    var searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.id = 'layerSearch';
    searchInput.placeholder = 'Search layers...';
    searchInput.style.width = '80%';
    searchInput.style.padding = '3px';
    searchInput.style.marginBottom = '6px';
    searchInput.style.borderRadius = '6px';
    searchInput.style.border = '1px solid #ccc';
    controlDiv.appendChild(searchInput);
  
  
  function updateInfoBox() {
    var infoBox = document.getElementById('layerInfoBox');
    var content = '';
    for (var key in activeLayerInfos) {
      content += '<strong>' + key + '</strong><br>' + activeLayerInfos[key] + '<hr>';
    }
    if (content) {
      infoBox.innerHTML = content;
      infoBox.style.display = 'block';
    } else {
      infoBox.style.display = 'none';
    }
  }
  
  // === Generate checkboxes and download links inside flex containers ===
for (var category in layerCategories) {
  var catHeader = document.createElement('h4');
  catHeader.textContent = category;
  controlDiv.appendChild(catHeader);

  layerCategories[category].forEach(function(layerInfo) {
    var id = layerInfo.name.replace(/\s+/g, '_');

    // Create flex row container
    var layerItem = document.createElement('div');
    layerItem.className = 'layer-item'; // Add a CSS class

    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = id;
    checkbox.dataset.filename = layerInfo.file;

    checkbox.dataset.layername = layerInfo.name;
    
    var label = document.createElement('label');
    label.htmlFor = id;
    label.textContent = layerInfo.name;

    var download = document.createElement('a');
    download.href = 'data/' + layerInfo.file;
    download.download = layerInfo.file;
    download.innerHTML = '&#129035;';  // ⇩ arrow
    download.className = 'download-button';
    download.style.display = 'none';

    // Add to flex row container
    layerItem.appendChild(checkbox);
    layerItem.appendChild(label);
    layerItem.appendChild(download);

    // Append the row to sidebar
    controlDiv.appendChild(layerItem);

    // Checkbox logic
      checkbox.addEventListener('change', function() {
        var filename = this.dataset.filename;
        var layername = this.dataset.layername;
        var link = this.parentElement.querySelector('.download-button');

        if (this.checked) {
          link.style.display = 'inline-block';
        
          // ✅ Add placeholder immediately
          activeLayerInfos[layername] = '<em>Loading info...</em>';
          updateInfoBox();
        
          fetch('data/' + filename)
            .then(res => res.json())
            .then(data => {
              var layer = L.geoJSON(data, {
                style: { color: 'blue', weight: 1, fillColor: 'lightblue', fillOpacity: 0.7 },
                pointToLayer: function (feature, latlng) {
                  return L.circleMarker(latlng, {
                    radius: 3, fillColor: '#40b3ff', color: '#40b3ff',
                    weight: 1, opacity: 1, fillOpacity: 0.5
                  });
                },
                onEachFeature: function (feature, layer) {
                  if (feature.properties) {
                    var popupContent = '<table>';
                    for (var key in feature.properties) {
                      var value = feature.properties[key];
                      var displayKey = key;
                
                      if (key.toLowerCase() === 'shapeleng_km') {
                        value = Number(value).toFixed(2);
                        displayKey = 'Shape Length (km)';
                      } else if (key.toLowerCase() === 'shapearea') {
                        value = Number(value).toFixed(2);
                        displayKey = 'Shape Area (km²)';
                      }
                
                      popupContent += '<tr><th style="text-align:left; padding-right:5px;">' + displayKey + '</th><td>' + value + '</td></tr>';
                    }
                    popupContent += '</table>';
                    layer.bindPopup(popupContent);
                  }
                }
              }).addTo(map);
              geojsonLayers[filename] = layer;
              map.fitBounds(layer.getBounds());
            });
        
          var txtFile = filename.replace(/\.[^/.]+$/, "") + ".txt";
          fetch('info/' + txtFile)
            .then(res => {
              if (!res.ok) throw new Error('No info file');
              return res.text();
            })
            .then(text => {
              activeLayerInfos[layername] = text;
              updateInfoBox();
            })
            .catch(err => {
              activeLayerInfos[layername] = '<em>No extra info available for this layer.</em>';
              updateInfoBox();
            });
        
        } else {
          link.style.display = 'none';
          if (geojsonLayers[filename]) {
            map.removeLayer(geojsonLayers[filename]);
            delete geojsonLayers[filename];
          }
          delete activeLayerInfos[layername];
          updateInfoBox();
        }
      });
    });
  }

  document.getElementById('closeWelcome').addEventListener('click', function() {
    document.getElementById('welcomeModal').style.display = 'none';
  });

  document.getElementById('layerSearch').addEventListener('input', function() {
    var searchTerm = this.value.toLowerCase();
    var layerItems = document.querySelectorAll('.layer-item');

    layerItems.forEach(function(item) {
      var label = item.querySelector('label').textContent.toLowerCase();
      if (label.includes(searchTerm)) {
        item.style.display = 'flex'; // or 'block' depending on your layout
      } else {
        item.style.display = 'none';
      }
    });
  });

</script>

</body>
</html>
